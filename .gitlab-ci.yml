variables:
  GITLAB_EE_VERSION: "master"
  GITLAB_CE_VERSION: "master"
  GITLAB_SHELL_VERSION: "master"
  GITALY_VERSION: "master"
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375

before_script:
  - source build-scripts/build.sh
  - export {CONTAINER_VERSION,BASE_VERSION}=$(get_version gitlab-ruby)
  - export TARGET_VERSION=$(get_target_version)
  - docker login -u gitlab-ci-token -p "$CI_JOB_TOKEN" "$CI_REGISTRY"

stages:
  - base-container
  - common-container
  - target-container

.job-base: &job-base
  image: "registry.gitlab.com/gitlab-org/gitlab-omnibus-builder:ruby_docker-0.0.7"
  services:
  - docker:dind
  dependencies: []
  retry: 1

gitlab-ruby:
  <<: *job-base
  stage: base-container
  script:
  - build_if_needed
  - push_if_master

gitlab-rails-ee:
  <<: *job-base
  stage: common-container
  script:
  - export CONTAINER_VERSION=($(echo -n "$BASE_VERSION$TARGET_VERSION$GITLAB_EE_VERSION$(date -u +%D)" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-ruby:$BASE_VERSION"
  - build_if_needed --build-arg "GITLAB_EDITION=gitlab-ee" --build-arg "GITLAB_VERSION=${GITLAB_EE_VERSION}" --build-arg "CACHE_BUSTER=$GITLAB_EE_VERSION$(date -uI)" --build-arg "TAG=$BASE_VERSION"
  - push_if_master $GITLAB_EE_VERSION
  except:
    variables:
      - $CE_PIPELINE

gitlab-rails-ce:
  <<: *job-base
  stage: common-container
  script:
  - export CONTAINER_VERSION=($(echo -n "$BASE_VERSION$TARGET_VERSION$GITLAB_CE_VERSION$(date -u +%D)" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-ruby:$BASE_VERSION"
  - build_if_needed --build-arg "GITLAB_EDITION=gitlab-ce" --build-arg "GITLAB_VERSION=${GITLAB_CE_VERSION}" --build-arg "CACHE_BUSTER=$GITLAB_CE_VERSION$(date -uI)" --build-arg "TAG=test-restore-hooks"
  - tag_and_push $GITLAB_CE_VERSION
  except:
    variables:
      - $EE_PIPELINE

gitlab-task-runner-ee:
  <<: *job-base
  stage: target-container
  script:
  - rails_version=$(get_version gitlab-rails)
  - rails_container=($(echo -n "$BASE_VERSION$rails_version$GITLAB_EE_VERSION$(date -u +%D)" | sha1sum))
  - export CONTAINER_VERSION=($(echo -n "$rails_container$TARGET_VERSION" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-rails-ee:$rails_container"
  - build_if_needed --build-arg "FROM_IMAGE=$CI_REGISTRY_IMAGE/gitlab-rails-ee" --build-arg "TAG=test-restore-hooks"
  - tag_and_push $GITLAB_EE_VERSION
  dependencies:
    - gitlab-rails-ee
  except:
    variables:
      - $CE_PIPELINE

gitlab-task-runner-ce:
  <<: *job-base
  stage: target-container
  script:
  - rails_version=$(get_version gitlab-rails)
  - rails_container=($(echo -n "$BASE_VERSION$rails_version$GITLAB_CE_VERSION$(date -u +%D)" | sha1sum))
  - export CONTAINER_VERSION=($(echo -n "$rails_container$TARGET_VERSION" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-rails-ce:$rails_container"
  - build_if_needed --build-arg "FROM_IMAGE=$CI_REGISTRY_IMAGE/gitlab-rails-ce" --build-arg "TAG=test-restore-hooks"
  - tag_and_push  $GITLAB_CE_VERSION
  dependencies:
    - gitlab-rails-ce
  except:
    variables:
      - $EE_PIPELINE

kubectl:
  <<: *job-base
  stage: base-container
  script:
  - export CONTAINER_VERSION=($(echo -n "$TARGET_VERSION$(date -u +%D)" | sha1sum))
  - build_if_needed
  - push_if_master

gitlab-unicorn-ee:
  <<: *job-base
  stage: target-container
  script:
  - rails_version=$(get_version gitlab-rails)
  - rails_container=($(echo -n "$BASE_VERSION$rails_version$GITLAB_EE_VERSION$(date -u +%D)" | sha1sum))
  - export CONTAINER_VERSION=($(echo -n "$rails_container$TARGET_VERSION" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-rails-ee:$rails_container"
  - build_if_needed --build-arg "FROM_IMAGE=$CI_REGISTRY_IMAGE/gitlab-rails-ee" --build-arg "TAG=$rails_container"
  - push_if_master $GITLAB_EE_VERSION
  dependencies:
    - gitlab-rails-ee
  except:
    variables:
      - $CE_PIPELINE

gitlab-unicorn-ce:
  <<: *job-base
  stage: target-container
  script:
  - rails_version=$(get_version gitlab-rails)
  - rails_container=($(echo -n "$BASE_VERSION$rails_version$GITLAB_CE_VERSION$(date -u +%D)" | sha1sum))
  - export CONTAINER_VERSION=($(echo -n "$rails_container$TARGET_VERSION" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-rails-ce:$rails_container"
  - build_if_needed --build-arg "FROM_IMAGE=$CI_REGISTRY_IMAGE/gitlab-rails-ce" --build-arg "TAG=$rails_container"
  - push_if_master $GITLAB_CE_VERSION
  dependencies:
    - gitlab-rails-ce
  except:
    variables:
      - $EE_PIPELINE

gitlab-sidekiq-ee:
  <<: *job-base
  stage: target-container
  script:
  - rails_version=$(get_version gitlab-rails)
  - rails_container=($(echo -n "$BASE_VERSION$rails_version$GITLAB_EE_VERSION$(date -u +%D)" | sha1sum))
  - export CONTAINER_VERSION=($(echo -n "$rails_container$TARGET_VERSION" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-rails-ee:$rails_container"
  - build_if_needed --build-arg "FROM_IMAGE=$CI_REGISTRY_IMAGE/gitlab-rails-ee" --build-arg "TAG=$rails_container"
  - push_if_master $GITLAB_EE_VERSION
  dependencies:
    - gitlab-rails-ee
  except:
    variables:
      - $CE_PIPELINE

gitlab-sidekiq-ce:
  <<: *job-base
  stage: target-container
  script:
  - rails_version=$(get_version gitlab-rails)
  - rails_container=($(echo -n "$BASE_VERSION$rails_version$GITLAB_CE_VERSION$(date -u +%D)" | sha1sum))
  - export CONTAINER_VERSION=($(echo -n "$rails_container$TARGET_VERSION" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-rails-ce:$rails_container"
  - build_if_needed --build-arg "FROM_IMAGE=$CI_REGISTRY_IMAGE/gitlab-rails-ce" --build-arg "TAG=$rails_container"
  - push_if_master $GITLAB_CE_VERSION
  dependencies:
    - gitlab-rails-ce
  except:
    variables:
      - $EE_PIPELINE

gitlab-shell:
  <<: *job-base
  stage: common-container
  script:
  - export CONTAINER_VERSION=($(echo -n "$BASE_VERSION$TARGET_VERSION$GITLAB_SHELL_VERSION$(date -u +%D)" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-ruby:$BASE_VERSION"
  - build_if_needed --build-arg "TAG=$BASE_VERSION" --build-arg "GITLAB_SHELL_VERSION=${GITLAB_SHELL_VERSION}" --build-arg "CACHE_BUSTER=$GITLAB_SHELL_VERSION$(date -uI)"
  - push_if_master $GITLAB_SHELL_VERSION
  dependencies:
    - gitlab-ruby

gitaly:
  <<: *job-base
  stage: target-container
  script:
  - shell_version=$(get_version gitlab-shell)
  - export shell_container=($(echo -n "$BASE_VERSION$shell_version$GITLAB_SHELL_VERSION$(date -u +%D)" | sha1sum))
  - export CONTAINER_VERSION=($(echo -n "$shell_container$GITALY_VERSION$TARGET_VERSION" | sha1sum))
  - export BASE_IMAGE="$CI_REGISTRY_IMAGE/gitlab-shell:$shell_container"
  - build_if_needed --build-arg "GITALY_VERSION=${GITALY_VERSION}" --build-arg "TAG=$BASE_VERSION" --build-arg "SHELL_CONTAINER=$shell_container" --build-arg "CACHE_BUSTER=$GITALY_VERSION$(date -uI)"
  - push_if_master $GITALY_VERSION
  dependencies:
    - gitlab-ruby
    - gitlab-shell

gitlab-redis-ha:
  <<: *job-base
  stage: target-container
  script:
  - export CONTAINER_VERSION=($(echo -n "$TARGET_VERSION$(date -u +%D)" | sha1sum))
  - build_if_needed
  - push_if_master
